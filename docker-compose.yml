services:
  # ── PostgreSQL ─────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: fraudshield
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: fraudshield
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fraudshield"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ── Redis (rate limiting / session cache) ──────────────────────────────────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
    volumes:
      - redis_data:/data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── API (Hono) ─────────────────────────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    restart: unless-stopped
    env_file:
      - path: .env
        required: false
    environment:
      NODE_ENV: production
      PORT: "3001"
      DATABASE_URL: postgresql://fraudshield:${POSTGRES_PASSWORD}@postgres:5432/fraudshield
    volumes:
      - ip_data:/app/data
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ── Customer Dashboard (Next.js) ───────────────────────────────────────────
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    restart: unless-stopped
    env_file:
      - path: .env
        required: false
    environment:
      NODE_ENV: production
      PORT: "3002"
      DATABASE_URL: postgresql://fraudshield:${POSTGRES_PASSWORD}@postgres:5432/fraudshield
      NEXTAUTH_URL: https://app.${DOMAIN:?DOMAIN is required}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:?NEXTAUTH_SECRET is required}
      STITCH_CLIENT_ID: ${STITCH_CLIENT_ID:-}
      STITCH_CLIENT_SECRET: ${STITCH_CLIENT_SECRET:-}
      STITCH_WEBHOOK_SECRET: ${STITCH_WEBHOOK_SECRET:-}
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3002/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ── Admin Panel (Next.js) ──────────────────────────────────────────────────
  admin:
    build:
      context: .
      dockerfile: Dockerfile.admin
    restart: unless-stopped
    env_file:
      - path: .env
        required: false
    environment:
      NODE_ENV: production
      PORT: "3003"
      DATABASE_URL: postgresql://fraudshield:${POSTGRES_PASSWORD}@postgres:5432/fraudshield
      NEXTAUTH_URL: https://admin.${DOMAIN:?DOMAIN is required}
      NEXTAUTH_SECRET: ${ADMIN_NEXTAUTH_SECRET:?ADMIN_NEXTAUTH_SECRET is required}
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3003/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ── IP List Updater (cron) ─────────────────────────────────────────────────
  ip-updater:
    image: node:20-alpine
    restart: unless-stopped
    environment:
      MAXMIND_LICENSE_KEY: ${MAXMIND_LICENSE_KEY:-}
    volumes:
      - ip_data:/data
      - ./packages/api/scripts:/scripts:ro
    command: >
      sh -c "
        apk add --no-cache wget curl &&
        sh /scripts/update-ip-lists.sh /data &&
        while true; do sleep 86400 && sh /scripts/update-ip-lists.sh /data; done
      "
    networks:
      - internal

  # ── Caddy (reverse proxy + automatic HTTPS) ────────────────────────────────
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    env_file:
      - path: .env
        required: false
    networks:
      - internal
    depends_on:
      api:
        condition: service_healthy
      dashboard:
        condition: service_healthy
      admin:
        condition: service_healthy

volumes:
  postgres_data:
  redis_data:
  ip_data:
  caddy_data:
  caddy_config:

networks:
  internal:
    driver: bridge
