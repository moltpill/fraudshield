# Progress Log

Started: Thu Feb 19 21:32:30 SAST 2026

## Phase 1: Foundation


## STORY-001: Initialize monorepo with pnpm workspaces ‚úÖ
- Created pnpm-workspace.yaml
- Created root package.json with workspace scripts
- Created tsconfig.json with @fraudshield/* path aliases
- Created package.json for all 5 packages (shared, sdk, api, dashboard, admin)
- Added .gitignore
- All 8 tests passing
- Committed: f02724d

### STORY-001: Initialize monorepo with pnpm workspaces ‚úÖ
- pnpm workspaces auto-create symlinks in packages/*/node_modules ‚Äî added to .gitignore


### STORY-002: Setup shared types package ‚úÖ
- Created Tier enum (FREE, STARTER, GROWTH, SCALE, ENTERPRISE)
- Created Account type with id, email, name, tier, status, createdAt
- Created ApiKey type with id, accountId, key, name, status, allowedDomains, createdAt
- Created Visitor type with id, fingerprint, firstSeen, lastSeen, visits
- Created VisitorEvent type with id, visitorId, apiKeyId, signals, risk, timestamp
- Created UsageRecord type with id, accountId, date, count
- All types exported from index.ts
- 6 tests passing
- Committed: 1f742a0

**Learning:** Root tsconfig has `noEmit: true` for type-checking only; packages needing build output must override with `noEmit: false`

### STORY-002: Setup shared types package ‚úÖ
- Created Account, ApiKey, Visitor, VisitorEvent, UsageRecord, Tier types
- Root tsconfig has noEmit: true; packages needing build must override with noEmit: false


### STORY-003: Setup Prisma schema for accounts and API keys ‚úÖ
- Created prisma/schema.prisma with Account and ApiKey models
- SQLite datasource for development (DATABASE_URL env var)
- Account fields: id, email (unique), name, tier, status, createdAt
- ApiKey fields: id, accountId, key (unique), name, status, allowedDomains (JSON string), createdAt
- Relation: Account has many ApiKeys with cascade delete
- Added db:generate, db:push, db:studio scripts to package.json
- 6 tests passing (create, relations, unique constraints, tier values)
- Committed: f01c5c9

**Learning:** SQLite doesn't support enums ‚Äî use String fields with application-level validation instead. Prisma 7 has breaking changes (config file required); Prisma 5 is more stable for quick setup.

### STORY-003: Setup Prisma schema for accounts and API keys ‚úÖ
- SQLite doesn't support enums ‚Äî use String fields with app-level validation
- Prisma 5 is stable; Prisma 7 has breaking changes
- allowedDomains stored as JSON string (parse at app level)



### STORY-004: Setup Prisma schema for visitors and events ‚úÖ
- Created Visitor model with fingerprint (unique), firstSeen, lastSeen, visitCount
- Created VisitorEvent model with signals (JSON string), riskScore, detection flags (isBot, isVpn, isTor, isDatacenter)
- Index on Visitor.fingerprint for fast lookup
- Index on VisitorEvent.timestamp for time-based queries
- Index on VisitorEvent.visitorId and apiKeyId for relation lookups
- Relations: VisitorEvent ‚Üí Visitor (cascade delete), VisitorEvent ‚Üí ApiKey (cascade delete)
- Added visitorEvents relation to ApiKey model
- 8 tests covering creation, constraints, relations, and index usage
- Committed: 225fa17

**Learning:** Prisma needs to run from the package directory containing the schema, or use pnpm workspace scripts

### STORY-004: Setup Prisma schema for visitors and events ‚úÖ
- Visitor: fingerprint (unique+indexed), firstSeen, lastSeen, visitCount
- VisitorEvent: signals JSON, riskScore, detection flags (isBot, isVpn, isTor, isDatacenter)
- Prisma must run from package directory containing schema (not project root)



### STORY-005: Setup Prisma schema for usage tracking ‚úÖ
- Created UsageRecord model with accountId, date, requestCount
- Unique constraint on accountId + date (for atomic daily tracking)
- Created TierLimit model with tier (unique), monthlyLimit, features JSON
- Seed script populates all 5 tiers: FREE (1K), STARTER (10K), GROWTH (100K), SCALE (1M), ENTERPRISE (unlimited)
- Added usageRecords relation to Account model
- Fixed test isolation in all test files (beforeEach cleanup)
- 36 tests passing
- Committed: ecdcd1a

**Learning:** Test isolation is critical ‚Äî always add beforeEach cleanup when tests create related data. Adding new relations requires updating cleanup order in existing test files.

### STORY-005: Setup Prisma schema for usage tracking ‚úÖ
- UsageRecord: accountId + date unique constraint, requestCount with default 0
- TierLimit: tier (unique), monthlyLimit, features JSON
- Seed via `pnpm db:seed` or `prisma db seed`
- Test isolation requires cleaning child tables before parents

### STORY-005: Setup Prisma schema for usage tracking ‚úÖ
- UsageRecord: accountId + date unique constraint for daily tracking
- TierLimit: tier limits and features JSON, seeded for all 5 tiers
- Test isolation critical ‚Äî always add beforeEach cleanup when tests create related data


### STORY-006: Create API key generation utility ‚úÖ
- Created packages/shared/src/api-key.ts with generateApiKey(), validateApiKey(), getApiKeyType()
- Format: fs_live_ or fs_test_ prefix + 32 hex chars (16 random bytes)
- Uses Node's crypto.randomBytes for cryptographic security
- 10 tests covering generation, uniqueness, and validation
- Exported from @fraudshield/shared package index
- Fixed pre-existing test flakiness by adding vitest.config.ts with fileParallelism: false
- Committed: 7304c40

**Learning:** Vitest runs test files in parallel by default, which causes race conditions with shared database tests. Use `fileParallelism: false` in vitest.config.ts when tests share a database.

### STORY-006: Create API key generation utility ‚úÖ
- generateApiKey('live'|'test') ‚Üí fs_live_/fs_test_ + 32 hex chars
- validateApiKey() checks format, getApiKeyType() extracts type
- Vitest runs files in parallel by default ‚Üí use fileParallelism: false for shared DB tests


### STORY-007: Setup Vitest for monorepo ‚úÖ
- Configured vitest.config.ts with test.projects (modern approach, replaces deprecated vitest.workspace.ts)
- Each package has its own vitest.config.ts with package-specific settings
- Root-level tests (tests/workspace.test.ts) included via inline project config
- Coverage enabled with @vitest/coverage-v8 (v8 provider)
- pnpm test at root runs all 46 tests across all packages
- pnpm --filter @fraudshield/shared test runs only shared package tests (16)
- pnpm --filter @fraudshield/api test runs only api package tests (22)
- Test scripts added: test, test:watch, test:coverage

**Learning:** vitest.workspace.ts is deprecated in Vitest 3.x. Use test.projects array in vitest.config.ts instead. Inline project configs work for root-level tests.

### STORY-007: Setup Vitest for monorepo ‚úÖ
- vitest.workspace.ts deprecated in Vitest 3.x ‚Äî use test.projects in vitest.config.ts
- Coverage with @vitest/coverage-v8 provider
- 46 tests total, all passing

## PHASE 1 COMPLETE ‚úÖ


---
## Phase 2: SDK Core
Started: Thu Feb 19 22:03:19 SAST 2026


### STORY-008: Create SDK package structure ‚úÖ
- TypeScript configured with strict mode (tsconfig.json)
- Rollup config for UMD, ESM, and minified bundles (rollup.config.js)
- FraudShield class with constructor({ apiKey, endpoint? })
- Build produces sdk.min.js = 656 bytes (well under 10KB requirement)
- Package exports FraudShield class with types
- 8 tests covering constructor, options, and exports
- Total: 54 tests passing across all packages

**Learning:** Use private fields with underscore prefix (_apiKey) when they'll be used by future methods but aren't yet ‚Äî satisfies strict mode's noUnusedLocals without disabling the check.

### STORY-008: Create SDK package structure ‚úÖ
- Rollup config for UMD, ESM, and minified bundles
- FraudShield class with constructor({ apiKey, endpoint? })
- Build output: 656 bytes (well under 10KB target)
- Use underscore prefix for private fields to satisfy noUnusedLocals



### STORY-009: Implement canvas fingerprint signal ‚úÖ
- getCanvasFingerprint() in packages/sdk/src/signals/canvas.ts
- Draws text with emoji (üõ°Ô∏è üé®), colored text, and arc shapes
- Uses djb2 hash on canvas.toDataURL() for consistent fingerprint
- Returns 'canvas-not-supported' gracefully when canvas unavailable
- 7 tests covering all acceptance criteria
- Bundle size: 1.38KB (well under 10KB target)
- Total: 61 tests passing

**Learning:** Use djb2 hash for simple client-side hashing ‚Äî fast, deterministic, no dependencies. Canvas fingerprinting works by exploiting rendering differences across browsers/systems.

### STORY-009: Implement canvas fingerprint signal ‚úÖ
- Draws text with emoji, colored text, and arc shapes
- djb2 hash on canvas.toDataURL() ‚Äî fast, deterministic, no deps
- Returns 'canvas-not-supported' when unavailable
- Bundle: 1.38KB



### STORY-010: Implement WebGL fingerprint signal ‚úÖ
- getWebGLFingerprint() returns { renderer, vendor, hash }
- Uses WEBGL_debug_renderer_info extension (constants 0x9245, 0x9246)
- Falls back to 'unknown' if debug extension unavailable
- Falls back to 'webgl-not-supported' if no WebGL context
- Includes shader precision info (vertex/fragment HIGH_FLOAT) in hash
- djb2 hash function for consistency
- 8 tests covering all acceptance criteria
- Bundle: 1.38KB (unchanged from STORY-009)
- Total: 69 tests passing

**Learning:** WebGL debug extension constants (UNMASKED_VENDOR_WEBGL, UNMASKED_RENDERER_WEBGL) are 0x9245 and 0x9246 respectively ‚Äî use them directly if debugInfo object doesn't expose them.

### STORY-010: Implement WebGL fingerprint signal ‚úÖ
- Returns { renderer, vendor, hash }
- Uses WEBGL_debug_renderer_info extension (constants 0x9245, 0x9246)
- Shader precision included in hash
- Graceful fallback for missing WebGL/debug extension



### STORY-011: Implement audio fingerprint signal ‚úÖ
- getAudioFingerprint() in packages/sdk/src/signals/audio.ts
- Uses OfflineAudioContext with webkit fallback
- Creates oscillator (triangle wave, 10kHz) + DynamicsCompressor chain
- Renders 4500 samples at 44100Hz, extracts channel data
- djb2 hash on float32 samples (6 decimal precision)
- Returns 'audio-not-supported' when AudioContext unavailable
- 8 tests covering all acceptance criteria
- Bundle: 1.38KB (unchanged from STORY-010)
- Total: 77 tests passing

**Learning:** Audio fingerprinting uses OfflineAudioContext to render audio offline, then extracts the Float32Array channel data. Different browser audio stacks produce slightly different output for the same oscillator/compressor config.

### STORY-011: Implement audio fingerprint signal ‚úÖ
- OfflineAudioContext with oscillator (10kHz triangle) + DynamicsCompressor
- Extracts Float32Array channel data, hashes with djb2
- webkitOfflineAudioContext fallback for Safari
- Different browser audio stacks = different fingerprints


### STORY-012: Implement navigator signals collection ‚úÖ
- Collects userAgent, platform, language, languages, hardwareConcurrency, deviceMemory
- Includes cookieEnabled, doNotTrack, maxTouchPoints, plugins list



### STORY-013: Implement screen signals collection ‚úÖ
- getScreenSignals() returns ScreenSignals object with all metrics
- Includes: width, height, availWidth, availHeight, colorDepth, pixelDepth, devicePixelRatio, orientation
- Handles iframe restrictions with safeGetScreenProp() wrapper - catches thrown errors
- Orientation extracted separately - checks for both type and angle properties
- 8 tests covering all acceptance criteria including error handling
- Bundle: 1.38KB (unchanged)
- Total: 100 tests passing

**Learning:** Iframe sandboxing can throw DOMException on screen property access, not just return undefined. Use try/catch wrappers for robust signal collection in embedded contexts.

### STORY-013: Implement screen signals collection ‚úÖ
- Returns width, height, availWidth, availHeight, colorDepth, pixelDepth, devicePixelRatio, orientation
- safeGetScreenProp() wrapper catches DOMExceptions from iframe sandboxing
- Iframe sandboxing can throw DOMException on screen access (not just undefined)



### STORY-014: Implement timezone and locale signals ‚úÖ
- getTimezoneSignals() returns { timezone, timezoneOffset, locale }
- Uses Intl.DateTimeFormat().resolvedOptions().timeZone for IANA timezone name
- Uses Date().getTimezoneOffset() for minutes offset from UTC
- Returns navigator.language for locale
- Graceful fallbacks when APIs unavailable
- 8 tests covering all acceptance criteria
- Total: 108 tests passing

**Learning:** Intl.DateTimeFormat().resolvedOptions() provides the IANA timezone name (e.g., "America/New_York"), while Date.getTimezoneOffset() returns numeric minutes offset (positive = behind UTC). Combining both gives robust timezone detection for fraud signals.

### STORY-014: Implement timezone and locale signals ‚úÖ
- Returns { timezone, timezoneOffset, locale }
- Intl.DateTimeFormat().resolvedOptions() gives IANA timezone (e.g., 'America/New_York')
- Date.getTimezoneOffset() gives numeric minutes offset
- navigator.language for locale


### STORY-015: Implement WebRTC local IP detection ‚úÖ
- getWebRTCIPs() returns array of unique local IP addresses
- Uses RTCPeerConnection with Google STUN server
- Creates data channel + offer to trigger ICE gathering
- Extracts IPs from ICE candidate strings via regex
- Filters for private IPs only (10.x, 172.16-31.x, 192.168.x, 127.x)
- 3-second timeout prevents hanging
- Handles WebRTC disabled/blocked gracefully
- Cleans up peer connection after detection
- 8 tests covering all acceptance criteria
- Total: 116 tests passing

**Learning:** WebRTC IP detection works by creating RTCPeerConnection with STUN, then parsing ICE candidates. Filter for private IPs (10.x, 172.16-31.x, 192.168.x) to detect VPN leaks - public IPs from STUN are not useful for local detection. Always close peer connection to avoid resource leaks.

### STORY-015: Implement WebRTC local IP detection ‚úÖ
- Uses RTCPeerConnection with STUN to trigger ICE candidate gathering
- ICE candidate format: "candidate:... <ip> <port> typ host"
- Private IP ranges: 10.x, 172.16-31.x, 192.168.x, 127.x
- 3s timeout prevents hanging when WebRTC is blocked

### STORY-015: Implement WebRTC local IP detection ‚úÖ
- RTCPeerConnection with STUN (stun.l.google.com:19302)
- Create data channel ‚Üí create offer ‚Üí parse ICE candidates
- Filter for private IPs only (10.x, 172.16-31.x, 192.168.x, 127.x)
- 3 second timeout, always close peer connection after


### STORY-016: Implement bot detection signals ‚úÖ
- getBotSignals() returns detection flags object with 5 boolean signals
- Checks navigator.webdriver (Selenium/Puppeteer detection)
- Checks window.phantom (PhantomJS)
- Checks window.__selenium_* artifacts (multiple variants)
- Checks chrome.runtime in non-Chrome browsers (inconsistent environment)
- Checks for fake permissions API (sync vs async query detection)
- 18 tests covering all acceptance criteria
- Total: 134 tests passing

**Learning:** Bot detection relies on artifacts left by automation tools. navigator.webdriver is set by WebDriver spec, window.phantom by PhantomJS, and various __selenium_* / __webdriver_* globals by Selenium. Chrome.runtime in non-Chrome browsers indicates environment spoofing. Fake permissions APIs often return synchronous results instead of Promises - real browsers always return Promises from permissions.query().

### STORY-016: Implement bot detection signals ‚úÖ
- webdriver: navigator.webdriver (Selenium/Puppeteer)
- phantom: window.phantom (PhantomJS)
- selenium: __selenium_*/__webdriver_* artifacts (12+ checks)
- chromeRuntime: chrome.runtime in non-Chrome
- inconsistentPermissions: fake sync permissions API (real returns Promise)



### STORY-017: Create SDK analyze() method ‚úÖ
- analyze() collects all 8 signal types in parallel (canvas, webgl, audio, navigator, screen, timezone, webrtcIPs, bot)
- POSTs to configured endpoint + /v1/analyze
- Includes Authorization: Bearer <apiKey> header
- Returns parsed JSON response (visitorId, riskScore, flags, etc.)
- FraudShieldError class with optional statusCode and code properties
- Handles network errors, HTTP errors, and JSON parse failures gracefully
- 14 tests covering all acceptance criteria
- Total: 148 tests passing

**Learning:** Use Promise.all() for async signal collectors (canvas, webgl, audio, navigator, webrtcIPs) to collect in parallel for performance. Sync collectors (screen, timezone, bot) run immediately after. FraudShieldError needs Object.setPrototypeOf(this, FraudShieldError.prototype) for correct instanceof checks in transpiled code.

### STORY-017: Create SDK analyze() method ‚úÖ
- Collects all 8 signal types in parallel (Promise.all for async signals)
- POSTs to endpoint/v1/analyze with Authorization: Bearer header
- FraudShieldError with statusCode and code properties
- Object.setPrototypeOf needed for correct instanceof in transpiled code

