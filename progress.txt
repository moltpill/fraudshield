# Progress Log

Started: Thu Feb 19 21:32:30 SAST 2026

## Phase 1: Foundation


## STORY-001: Initialize monorepo with pnpm workspaces ✅
- Created pnpm-workspace.yaml
- Created root package.json with workspace scripts
- Created tsconfig.json with @fraudshield/* path aliases
- Created package.json for all 5 packages (shared, sdk, api, dashboard, admin)
- Added .gitignore
- All 8 tests passing
- Committed: f02724d

### STORY-001: Initialize monorepo with pnpm workspaces ✅
- pnpm workspaces auto-create symlinks in packages/*/node_modules — added to .gitignore


### STORY-002: Setup shared types package ✅
- Created Tier enum (FREE, STARTER, GROWTH, SCALE, ENTERPRISE)
- Created Account type with id, email, name, tier, status, createdAt
- Created ApiKey type with id, accountId, key, name, status, allowedDomains, createdAt
- Created Visitor type with id, fingerprint, firstSeen, lastSeen, visits
- Created VisitorEvent type with id, visitorId, apiKeyId, signals, risk, timestamp
- Created UsageRecord type with id, accountId, date, count
- All types exported from index.ts
- 6 tests passing
- Committed: 1f742a0

**Learning:** Root tsconfig has `noEmit: true` for type-checking only; packages needing build output must override with `noEmit: false`

### STORY-002: Setup shared types package ✅
- Created Account, ApiKey, Visitor, VisitorEvent, UsageRecord, Tier types
- Root tsconfig has noEmit: true; packages needing build must override with noEmit: false


### STORY-003: Setup Prisma schema for accounts and API keys ✅
- Created prisma/schema.prisma with Account and ApiKey models
- SQLite datasource for development (DATABASE_URL env var)
- Account fields: id, email (unique), name, tier, status, createdAt
- ApiKey fields: id, accountId, key (unique), name, status, allowedDomains (JSON string), createdAt
- Relation: Account has many ApiKeys with cascade delete
- Added db:generate, db:push, db:studio scripts to package.json
- 6 tests passing (create, relations, unique constraints, tier values)
- Committed: f01c5c9

**Learning:** SQLite doesn't support enums — use String fields with application-level validation instead. Prisma 7 has breaking changes (config file required); Prisma 5 is more stable for quick setup.

### STORY-003: Setup Prisma schema for accounts and API keys ✅
- SQLite doesn't support enums — use String fields with app-level validation
- Prisma 5 is stable; Prisma 7 has breaking changes
- allowedDomains stored as JSON string (parse at app level)



### STORY-004: Setup Prisma schema for visitors and events ✅
- Created Visitor model with fingerprint (unique), firstSeen, lastSeen, visitCount
- Created VisitorEvent model with signals (JSON string), riskScore, detection flags (isBot, isVpn, isTor, isDatacenter)
- Index on Visitor.fingerprint for fast lookup
- Index on VisitorEvent.timestamp for time-based queries
- Index on VisitorEvent.visitorId and apiKeyId for relation lookups
- Relations: VisitorEvent → Visitor (cascade delete), VisitorEvent → ApiKey (cascade delete)
- Added visitorEvents relation to ApiKey model
- 8 tests covering creation, constraints, relations, and index usage
- Committed: 225fa17

**Learning:** Prisma needs to run from the package directory containing the schema, or use pnpm workspace scripts

### STORY-004: Setup Prisma schema for visitors and events ✅
- Visitor: fingerprint (unique+indexed), firstSeen, lastSeen, visitCount
- VisitorEvent: signals JSON, riskScore, detection flags (isBot, isVpn, isTor, isDatacenter)
- Prisma must run from package directory containing schema (not project root)



### STORY-005: Setup Prisma schema for usage tracking ✅
- Created UsageRecord model with accountId, date, requestCount
- Unique constraint on accountId + date (for atomic daily tracking)
- Created TierLimit model with tier (unique), monthlyLimit, features JSON
- Seed script populates all 5 tiers: FREE (1K), STARTER (10K), GROWTH (100K), SCALE (1M), ENTERPRISE (unlimited)
- Added usageRecords relation to Account model
- Fixed test isolation in all test files (beforeEach cleanup)
- 36 tests passing
- Committed: ecdcd1a

**Learning:** Test isolation is critical — always add beforeEach cleanup when tests create related data. Adding new relations requires updating cleanup order in existing test files.

### STORY-005: Setup Prisma schema for usage tracking ✅
- UsageRecord: accountId + date unique constraint, requestCount with default 0
- TierLimit: tier (unique), monthlyLimit, features JSON
- Seed via `pnpm db:seed` or `prisma db seed`
- Test isolation requires cleaning child tables before parents

### STORY-005: Setup Prisma schema for usage tracking ✅
- UsageRecord: accountId + date unique constraint for daily tracking
- TierLimit: tier limits and features JSON, seeded for all 5 tiers
- Test isolation critical — always add beforeEach cleanup when tests create related data


### STORY-006: Create API key generation utility ✅
- Created packages/shared/src/api-key.ts with generateApiKey(), validateApiKey(), getApiKeyType()
- Format: fs_live_ or fs_test_ prefix + 32 hex chars (16 random bytes)
- Uses Node's crypto.randomBytes for cryptographic security
- 10 tests covering generation, uniqueness, and validation
- Exported from @fraudshield/shared package index
- Fixed pre-existing test flakiness by adding vitest.config.ts with fileParallelism: false
- Committed: 7304c40

**Learning:** Vitest runs test files in parallel by default, which causes race conditions with shared database tests. Use `fileParallelism: false` in vitest.config.ts when tests share a database.

### STORY-006: Create API key generation utility ✅
- generateApiKey('live'|'test') → fs_live_/fs_test_ + 32 hex chars
- validateApiKey() checks format, getApiKeyType() extracts type
- Vitest runs files in parallel by default → use fileParallelism: false for shared DB tests


### STORY-007: Setup Vitest for monorepo ✅
- Configured vitest.config.ts with test.projects (modern approach, replaces deprecated vitest.workspace.ts)
- Each package has its own vitest.config.ts with package-specific settings
- Root-level tests (tests/workspace.test.ts) included via inline project config
- Coverage enabled with @vitest/coverage-v8 (v8 provider)
- pnpm test at root runs all 46 tests across all packages
- pnpm --filter @fraudshield/shared test runs only shared package tests (16)
- pnpm --filter @fraudshield/api test runs only api package tests (22)
- Test scripts added: test, test:watch, test:coverage

**Learning:** vitest.workspace.ts is deprecated in Vitest 3.x. Use test.projects array in vitest.config.ts instead. Inline project configs work for root-level tests.

### STORY-007: Setup Vitest for monorepo ✅
- vitest.workspace.ts deprecated in Vitest 3.x — use test.projects in vitest.config.ts
- Coverage with @vitest/coverage-v8 provider
- 46 tests total, all passing

## PHASE 1 COMPLETE ✅


---
## Phase 2: SDK Core
Started: Thu Feb 19 22:03:19 SAST 2026


### STORY-008: Create SDK package structure ✅
- TypeScript configured with strict mode (tsconfig.json)
- Rollup config for UMD, ESM, and minified bundles (rollup.config.js)
- FraudShield class with constructor({ apiKey, endpoint? })
- Build produces sdk.min.js = 656 bytes (well under 10KB requirement)
- Package exports FraudShield class with types
- 8 tests covering constructor, options, and exports
- Total: 54 tests passing across all packages

**Learning:** Use private fields with underscore prefix (_apiKey) when they'll be used by future methods but aren't yet — satisfies strict mode's noUnusedLocals without disabling the check.
